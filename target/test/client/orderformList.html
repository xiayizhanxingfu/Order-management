<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>订单</title>
        <script src="/test/js/jquery-3.4.1.js"></script>
    </head>
    <body>
        <div id="container" style="text-align: center;">
            <table id="info">
                <tr id="thead">

                </tr>
            </table>
            <button id="checkAll">全选</button>
            <label>合计<label id="sum">0</label></label>
            <button id="settleAccounts">结算</button>
            <button id="back">返回</button>
        </div>
        <script type="text/javascript">
            var toggle = 0;
            var baseUrl = "http://localhost:8080/test";
            $(function () {
                init();
                $("#settleAccounts").on("click", settleAccounts);
                $("#back").on("click", back);
                $("#checkAll").on("click", checkAll);
            });

            //初始化
            function init() {
                $.ajax({
                    url: baseUrl + "/client/orderformList",
                    type: "GET",
                    dataType: "json",
                    success: function (json) {
                        if (json.status === "error") {
                            alert("请登录")
                            window.location.href = baseUrl;
                        } else {
                            var th = "<th>编号</th>";
                            th += "<th>名称</th>";
                            th += "<th>图片</th>";
                            th += "<th>价格</th>";
                            th += "<th>类别</th>";
                            th += "<th>状态</th>";
                            th += "<th>数量</th>";
                            $("#thead").append($(th));
                            console.log(json);
                            for (var i = 0; i < json.orderformList.length; i++) {
                                var tr = "<td>" + json.orderformList[i].orderId + "</td>";
                                tr += "<td>" + json.orderformList[i].food.foodName + "</td>";
                                tr += "<td>" + json.orderformList[i].food.foodUrl + "</td>";
                                if (json.orderformList[i].food.foodDprice > json.orderformList[i].food.foodPrice) {
                                    tr += "<td>" + json.orderformList[i].food.foodDprice + "</td>";
                                } else {
                                    tr += "<td>" + json.orderformList[i].food.foodPrice + "</td>";
                                }
                                tr += "<td>" + json.orderformList[i].food.foodClassify.fcName + "</td>";
                                var status = json.orderformList[i].status;
                                switch (status) {
                                    case 0:
                                        status = "未付款";
                                        break;
                                    case 1:
                                        status = "己付款";
                                        break;
                                    case 2:
                                        status = "未上菜";
                                        break;
                                    case 3:
                                        status = "完成交易";
                                        break;
                                }
                                tr += "<td status='" + json.orderformList[i].status + "'>" + status + "</td>";
                                if (json.orderformList[i].status === 0) {
                                    tr += "<td><input  min='1' type='number' value='" + json.orderformList[i].size + "'></td>";
                                    tr += "<td><input type='checkbox'></td>";
                                } else {
                                    tr += "<td><input type='number'  disabled='disabled' value='" + json.orderformList[i].size + "'></td>";
                                }
                                $("#info").append($("<tr>" + tr + "</tr>"));
                            }
                        }
                        $("input:checkbox").on("click", function () {
                            $("#sum").text(total());
                        });
                        $("input[type='number']").on("input", function () {
                            if ($(this).text() < 0) {
                                alert("数量必须大于0");
                                return false;
                            } else {
                                $("#sum").text(total());
                            }
                        });
                    }
                });
            }

            //结算
            function settleAccounts() {
                var localtion=prompt("请输入你的位置");
                if (localtion === ''||localtion ===null) {
                    alert('不能为空');
                    return false;
                }

                var orderforms = $("input[type='checkbox']:checked");
                var ids = [];
                var sizes = [];
                for (var i = 0; i < orderforms.length; i++) {
                    ids[i] = $(orderforms[i]).parents("tr").find("td:first").text()
                    sizes[i] = $(orderforms[i]).parent("td").prev("td").find("input").val();
                }
                if (ids.length <= 0) {
                    alert("请选择商品");
                }
                $.ajax({
                    url: baseUrl + "/client/settleAccounts",
                    type: "GET",
                    data: {
                        id: ids,
                        size:sizes,
                        localtion:localtion
                    },
                    dataType: "json",
                    success: function (json) {
                        if (json.status === "error") {
                            alert("请登录")
                            window.location.href = baseUrl;
                        } else if (json.status === "ok") {
                            var sum = $("#sum").text();
                            alert("你一共消费了" + sum + "元");
                            window.location.href = baseUrl + "/client/orderformList.html";
                        }
                    }
                });
            }

            //返回上一个页面
            function back() {
                window.location.href = baseUrl + "/client/foodList.html";
            }

            //全选和取消全选
            function checkAll() {
                if (toggle == 0) {
                    //全选
                    $("input:checkbox").prop("checked", true);
                    $("#sum").text(total());
                    toggle = 1;
                } else {
                    //取消全选
                    $("input:checkbox").prop("checked", false);
                    $("#sum").text(0);
                    toggle = 0;
                }
            }

            //计算总价
            function total() {
                var sum = 0;
                var orderforms = $("input[type='checkbox']:checked");
                for (var i = 0; i < orderforms.length; i++) {
                    var size = $(orderforms[i]).parent("td").prev("td").find("input").val();
                    if (size <= 0) {
                        alert("数量必须要大于0");
                        size = 1;
                        $(orderforms[i]).parent("td").prev("td").find("input").val(size);
                    }
                    var price = $(orderforms[i]).parent("td").prev("td").prev("td").prev("td").prev("td").text();
                    sum += Number(size) * Number(price);
                }
                return sum;
            }
        </script>
    </body>
</html>